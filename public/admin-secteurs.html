<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Secteurs - OFPPT Province de Settat</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Script d'authentification s√©curis√© c√¥t√© serveur -->
<script>
  // === CONFIGURATION ===
  const API_BASE = window.location.origin; // Utilise le m√™me domaine
  
  // === FONCTIONS D'AUTHENTIFICATION S√âCURIS√âE ===
  function isAuthenticated() {
    const token = localStorage.getItem('admin_token');
    if (!token) {
      console.log('Non authentifi√©: aucun token');
      return false;
    }
    console.log('Token trouv√©');
    return true;
  }
  
  async function login(password) {
    try {
      console.log('Envoi de la requ√™te de connexion au serveur');
      const response = await fetch(`${API_BASE}/api/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: 'admin',
          password: password
        })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        console.error('Erreur serveur:', data.error);
        return false;
      }
      
      if (data.ok && data.token) {
        localStorage.setItem('admin_token', data.token);
        console.log('Connexion r√©ussie, token stock√©');
        return true;
      }
      
      console.log('R√©ponse invalide du serveur');
      return false;
    } catch (error) {
      console.error('Erreur lors de la connexion:', error);
      return false;
    }
  }
  
  function logout() {
    console.log('D√©connexion en cours...');
    localStorage.removeItem('admin_token');
    console.log('D√©connexion r√©ussie');
    // Rediriger vers la page de login
    showLoginScreen();
  }
  
  function protectPage() {
    console.log('V√©rification de l\'authentification...');
    if (!isAuthenticated()) {
      console.log('Non authentifi√©, affichage √©cran login');
      showLoginScreen();
      return false;
    }
    console.log('Page prot√©g√©e, affichage contenu admin');
    return true;
  }
  
  function getAuthToken() {
    return localStorage.getItem('admin_token');
  }
  
  // Helper pour faire des requ√™tes authentifi√©es au serveur
  async function authenticatedFetch(url, options = {}) {
    const token = getAuthToken();
    const headers = options.headers || {};
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }
    return fetch(url, { ...options, headers });
  }

  
  // === √âCRAN DE LOGIN ===
  function showLoginScreen() {
    console.log('Affichage √©cran de login');
    document.body.innerHTML = '';
    document.body.style.background = 'linear-gradient(135deg, #0b4da2 0%, #005c99 100%)';
    document.body.style.minHeight = '100vh';
    document.body.style.display = 'flex';
    document.body.style.alignItems = 'center';
    document.body.style.justifyContent = 'center';
    document.body.style.padding = '20px';
    
    const loginHTML = `
      <style>
        .login-container { 
          background: white; 
          border-radius: 20px; 
          padding: 40px; 
          width: 100%; 
          max-width: 400px; 
          box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
          text-align: center; 
        }
        .logo i { 
          font-size: 3rem; 
          color: #0b4da2; 
          margin-bottom: 15px; 
        }
        .logo h1 { 
          color: #1e293b; 
          font-size: 1.8rem; 
          margin-bottom: 5px; 
        }
        .logo p { 
          color: #64748b; 
          font-size: 0.95rem; 
        }
        .login-form { 
          margin-top: 30px; 
        }
        .form-group { 
          margin-bottom: 20px; 
          text-align: left; 
        }
        .form-group label { 
          display: block; 
          margin-bottom: 8px; 
          color: #1e293b; 
          font-weight: 500; 
          font-size: 0.9rem; 
        }
        .password-input { 
          position: relative; 
        }
        .password-input input { 
          width: 100%; 
          padding: 14px 45px 14px 14px; 
          border: 2px solid #e2e8f0; 
          border-radius: 10px; 
          font-size: 1rem; 
        }
        .password-input input:focus { 
          outline: none; 
          border-color: #0b4da2; 
          box-shadow: 0 0 0 3px rgba(11,77,162,0.1); 
        }
        .toggle-password { 
          position: absolute; 
          right: 14px; 
          top: 50%; 
          transform: translateY(-50%); 
          background: none; 
          border: none; 
          color: #64748b; 
          cursor: pointer; 
          font-size: 1.1rem; 
        }
        .btn-login { 
          width: 100%; 
          padding: 14px; 
          background: linear-gradient(135deg, #0b4da2 0%, #005c99 100%); 
          color: white; 
          border: none; 
          border-radius: 10px; 
          font-size: 1rem; 
          font-weight: 600; 
          cursor: pointer; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          gap: 10px; 
          margin-top: 10px; 
        }
        .btn-login:hover { 
          transform: translateY(-2px); 
          box-shadow: 0 8px 20px rgba(11,77,162,0.3); 
        }
        .message { 
          padding: 12px; 
          border-radius: 8px; 
          margin-bottom: 20px; 
          display: none; 
        }
        .message.error { 
          background: #fee2e2; 
          border: 1px solid #ef4444; 
          color: #7f1d1d; 
        }
        .message.success { 
          background: #d1fae5; 
          border: 1px solid #10b981; 
          color: #065f46; 
        }
        .back-link { 
          margin-top: 25px; 
          text-align: center; 
        }
        .back-link a { 
          color: #64748b; 
          text-decoration: none; 
          font-size: 0.9rem; 
          display: inline-flex; 
          align-items: center; 
          gap: 6px; 
        }
        .back-link a:hover { 
          color: #0b4da2; 
        }
      </style>
      
      <div class="login-container">
        <div class="logo">
          <i class="fas fa-lock"></i>
          <h1>Administration</h1>
          <p>OFPPT - Secteurs de Formation</p>
          <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 10px;">Acc√®s r√©serv√© au personnel autoris√©</p>
        </div>
        
        <div id="message" class="message"></div>
        
        <form class="login-form" id="loginForm">
          <div class="form-group">
            <label for="password">Mot de passe</label>
            <div class="password-input">
              <input type="password" id="password" placeholder="Entrez le mot de passe" required autofocus>
              <button type="button" class="toggle-password" id="togglePassword">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          
          <button type="submit" class="btn-login">
            <i class="fas fa-sign-in-alt"></i> Se connecter
          </button>
        </form>
        
        <div class="back-link">
          <a href="offre de formation.html">
            <i class="fas fa-arrow-left"></i> Retour au site
          </a>
        </div>
      </div>
    `;
    
    document.body.innerHTML = loginHTML;
    
    // Gestion de l'affichage/masquage du mot de passe
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    
    if (togglePassword && passwordInput) {
      togglePassword.addEventListener('click', function() {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      });
    }
    
    // Gestion de la connexion
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const password = passwordInput.value.trim();
        const messageDiv = document.getElementById('message');
        const submitBtn = loginForm.querySelector('button[type="submit"]');
        
        messageDiv.className = 'message';
        messageDiv.textContent = '';
        messageDiv.style.display = 'none';
        
        if (!password) {
          showMessage('Veuillez entrer le mot de passe', 'error');
          return;
        }
        
        // D√©sactiver le bouton pendant la requ√™te
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> V√©rification...';
        
        const success = await login(password);
        
        if (success) {
          showMessage('Connexion r√©ussie ! Redirection...', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showMessage('Mot de passe incorrect', 'error');
          passwordInput.value = '';
          passwordInput.focus();
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Se connecter';
        }
        
        function showMessage(text, type) {
          messageDiv.textContent = text;
          messageDiv.className = `message ${type}`;
          messageDiv.style.display = 'block';
        }
      });
    }
  }
  
  // Exposer logout globalement
  window.logout = logout;
  
  // V√©rifier l'authentification au chargement
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM charg√©, v√©rification auth...');
    if (!protectPage()) {
      console.log('Auth √©chou√©e, login screen affich√©');
      // Login screen d√©j√† affich√© par protectPage()
    } else {
      console.log('Auth r√©ussie, chargement interface admin');
      // L'interface admin sera charg√©e normalement
    }
  });
</script>

<style>
  /* === STYLES ADMIN (visible seulement si authentifi√©) === */
  :root {
    --primary-blue: #0b4da2;
    --primary-green: #2ecc71;
    --accent-orange: #f59e0b;
    --light-bg: #f8fafc;
    --card-bg: #ffffff;
    --text-dark: #1e293b;
    --text-light: #64748b;
    --border: #e2e8f0;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  }

  body {
    background: var(--light-bg);
    color: var(--text-dark);
    min-height: 100vh;
    display: block !important; /* Important pour √©viter le conflit avec le style du login */
  }

  .admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Header */
  .admin-header {
    background: var(--primary-blue);
    color: white;
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: 0 8px 24px rgba(11, 77, 162, 0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
  }

  .admin-header h1 {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.8rem;
  }

  .btn {
    padding: 10px 20px;
    border-radius: 30px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--primary-green);
    color: white;
  }

  .btn-primary:hover {
    background: #25a25a;
    transform: translateY(-2px);
  }

  .btn-outline {
    background: transparent;
    border: 2px solid white;
    color: white;
  }

  .btn-logout {
    background: #ef4444;
    color: white;
  }

  .btn-logout:hover {
    background: #dc2626;
    transform: translateY(-2px);
  }

  /* Main layout */
  .admin-main {
    display: grid;
    grid-template-columns: 450px 1fr;
    gap: 2rem;
  }

  /* Form section */
  .form-section {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
    border: 1px solid var(--border);
  }

  .form-section h3 {
    font-size: 1.3rem;
    margin-bottom: 1.5rem;
    padding-bottom: 12px;
    border-bottom: 3px solid var(--primary-blue);
    color: var(--primary-blue);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.95rem;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #fefefe;
  }

  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(11, 77, 162, 0.1);
  }

  .form-group textarea {
    min-height: 120px;
    resize: vertical;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  /* Dynamic fields */
  .stat-field, .skill-field {
    background: #f8fafc;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    margin-bottom: 15px;
  }

  .field-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .field-header h4 {
    margin: 0;
    color: var(--primary-blue);
    font-size: 14px;
  }

  .btn-delete {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 12px;
  }

  /* Preview section */
  .preview-section {
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }

  .preview-card {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--border);
    margin-bottom: 1.5rem;
  }

  .preview-card h4 {
    color: var(--primary-blue);
    margin-bottom: 1rem;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .preview-hero {
    height: 200px;
    background-size: cover;
    background-position: center;
    border-radius: 16px;
    position: relative;
    margin-bottom: 1rem;
    overflow: hidden;
    background-color: #e5e7eb;
  }

  .preview-hero img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Liste des secteurs */
  .secteurs-list {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--border);
  }

  .secteur-item {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 12px;
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .secteur-actions {
    display: flex;
    gap: 8px;
  }

  .btn-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .btn-icon.view {
    color: #10b981;
  }

  .btn-icon.view:hover {
    background: #10b981;
    color: white;
    transform: translateY(-2px);
  }

  .btn-icon.edit {
    color: var(--primary-blue);
  }

  .btn-icon.edit:hover {
    background: var(--primary-blue);
    color: white;
    transform: translateY(-2px);
  }

  .btn-icon.delete {
    color: #ef4444;
  }

  .btn-icon.delete:hover {
    background: #ef4444;
    color: white;
    transform: translateY(-2px);
  }

  /* Message */
  .message {
    padding: 1rem;
    border-radius: 12px;
    margin: 1rem 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .message.success {
    background: #d1fae5;
    border: 1px solid #10b981;
    color: #065f46;
  }

  .message.error {
    background: #fee2e2;
    border: 1px solid #ef4444;
    color: #7f1d1d;
  }

  /* Bouton Annuler */
  .btn-annuler {
    background: #64748b !important;
    color: white !important;
  }

  .btn-annuler:hover {
    background: #475569 !important;
    transform: translateY(-2px);
  }

  /* Styles pour les boutons d'ic√¥nes */
  .icon-options {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }

  .icon-option {
    padding: 10px 14px;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    font-size: 0.9em;
  }

  .icon-option:hover {
    border-color: #93c5fd;
    background: #f0f9ff;
    transform: translateY(-2px);
  }

  .icon-option.selected {
    border-color: #0b4da2;
    background: #e0f2fe;
    box-shadow: 0 2px 8px rgba(11, 77, 162, 0.15);
  }

  .icon-option i {
    color: #0b4da2;
    font-size: 1.1em;
  }

  .icon-option span {
    font-size: 0.85em;
    color: #1e293b;
    white-space: nowrap;
  }

  /* Styles pour les champs d'entr√©e */
  .stat-input[type="text"], .skill-input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.95rem;
    margin-top: 4px;
  }

  .stat-input[type="text"]:focus, .skill-input[type="text"]:focus {
    outline: none;
    border-color: #0b4da2;
    box-shadow: 0 0 0 3px rgba(11, 77, 162, 0.1);
  }

  @media (max-width: 1024px) {
    .admin-main {
      grid-template-columns: 1fr;
    }
    
    .admin-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .admin-header > div {
      display: flex;
      gap: 10px;
      width: 100%;
      justify-content: flex-start;
    }
  }
  
  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .icon-options {
      flex-direction: column;
    }
    
    .icon-option {
      width: 100%;
      justify-content: flex-start;
    }
  }
</style>
</head>
<body>
  <!-- === CONTENU ADMIN (visible seulement si authentifi√©) === -->
  <div class="admin-container" id="admin-content" style="display: none;">
    <header class="admin-header">
      <h1>
        <i class="fas fa-cogs"></i>
        Administration des Secteurs
      </h1>
      <div>
        <a href="offre de formation.html" class="btn btn-outline">
          <i class="fas fa-eye"></i> Voir site
        </a>
        <button onclick="logout()" class="btn btn-logout">
          <i class="fas fa-sign-out-alt"></i> D√©connexion
        </button>
      </div>
    </header>

    <div class="admin-main">
      <!-- Formulaire -->
      <div class="form-column">
        <!-- Ext√©rieur -->
        <section class="form-section">
          <h3><i class="fas fa-external-link-alt"></i> Ext√©rieur (Carte secteur)</h3>
          
          <div class="form-group">
            <label for="ext_titre">Titre du secteur *</label>
            <input type="text" id="ext_titre" placeholder="Ex: Digital et Intelligence Artificielle">
          </div>
          
          <div class="form-group">
            <label for="ext_image">Image de la carte (URL) *</label>
            <input type="url" id="ext_image" placeholder="https://example.com/image.jpg">
          </div>
          
          <div class="form-group">
            <label for="ext_resume">R√©sum√© court *</label>
            <textarea id="ext_resume" placeholder="Description courte qui appara√Æt sur la carte"></textarea>
          </div>
        </section>

        <!-- Int√©rieur -->
        <section class="form-section">
          <h3><i class="fas fa-home"></i> Int√©rieur (Page d√©tail)</h3>
          
          <div class="form-group">
            <label for="int_hero">Image HERO (URL)</label>
            <input type="url" id="int_hero" placeholder="https://example.com/hero-image.jpg">
          </div>
          
          <div class="form-group">
            <label for="int_presentation">Pr√©sentation du secteur</label>
            <textarea id="int_presentation" placeholder="Description d√©taill√©e du secteur"></textarea>
          </div>
          
          <div class="form-group">
            <label for="int_video">URL de la vid√©o (YouTube ou MP4)</label>
            <input type="url" id="int_video" placeholder="https://youtube.com/embed/... ou video.mp4">
          </div>
        </section>

        <!-- Chiffres cl√©s -->
        <section class="form-section">
          <h3><i class="fas fa-chart-bar"></i> Chiffres cl√©s</h3>
          <div id="stats-container"></div>
          <button type="button" id="add-stat" class="btn btn-primary">
            <i class="fas fa-plus"></i> Ajouter un chiffre cl√©
          </button>
        </section>

        <!-- Comp√©tences -->
        <section class="form-section">
          <h3><i class="fas fa-star"></i> Comp√©tences recherch√©es</h3>
          <div id="skills-container"></div>
          <button type="button" id="add-skill" class="btn btn-primary">
            <i class="fas fa-plus"></i> Ajouter une comp√©tence
          </button>
        </section>

        <!-- Fili√®res -->
        <section class="form-section">
          <h3><i class="fas fa-graduation-cap"></i> Fili√®res</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="filieres_count">Nombre de fili√®res</label>
              <input type="number" id="filieres_count" min="1" value="1">
            </div>
            
            <div class="form-group">
              <label for="etabs_count">Nombre d'√©tablissements</label>
              <input type="number" id="etabs_count" min="1" value="1">
            </div>
          </div>
          
          <div class="form-group">
            <label for="filieres_intro">Introduction des fili√®res</label>
            <textarea id="filieres_intro" placeholder="Description des fili√®res propos√©es"></textarea>
          </div>
        </section>

        <!-- Boutons action -->
        <div class="form-section">
          <div id="message-container"></div>
          
          <div style="display: flex; gap: 1rem;">
            <button type="button" id="btn-publier" class="btn btn-primary" style="flex: 1;">
              <i class="fas fa-paper-plane"></i> Publier le secteur
            </button>
            <button type="button" id="btn-annuler" class="btn btn-annuler">
              <i class="fas fa-times"></i> Annuler
            </button>
          </div>
        </div>
      </div>

      <!-- Preview -->
      <div class="preview-section">
        <div class="preview-card">
          <h4><i class="fas fa-mobile-alt"></i> Aper√ßu Carte</h4>
          <div class="preview-hero" id="preview-hero">
            <img id="preview-img" style="display: none;">
          </div>
          <h3 id="preview-titre" style="margin: 10px 0; color: var(--primary-blue);">Titre du secteur</h3>
          <p id="preview-resume" style="color: var(--text-light);">Description...</p>
        </div>

        <div class="preview-card">
          <h4><i class="fas fa-chart-line"></i> Chiffres cl√©s</h4>
          <div id="preview-stats">Aucun chiffre ajout√©</div>
        </div>

        <div class="preview-card">
          <h4><i class="fas fa-star"></i> Comp√©tences</h4>
          <div id="preview-skills">Aucune comp√©tence ajout√©e</div>
        </div>
      </div>
    </div>

    <!-- Liste des secteurs -->
    <section class="secteurs-list">
      <h3><i class="fas fa-list"></i> Secteurs publi√©s</h3>
      <div id="liste-secteurs"></div>
    </section>
  </div>

  <!-- === SCRIPT ADMIN PRINCIPAL === -->
  <script src="secteurs-api.js"></script>
  <script>
    // === CONFIGURATION IC√îNES ===
    const statIcons = [
      { value: 'fa-users', label: 'üë• Personnes' },
      { value: 'fa-briefcase', label: 'üíº Emplois' },
      { value: 'fa-chart-pie', label: 'üìä Statistiques' },
      { value: 'fa-building', label: 'üè¢ Entreprises' },
      { value: 'fa-industry', label: 'üè≠ Industrie' }
    ];
    
    const skillIcons = [
      { value: 'fa-people-group', label: 'üë• √âquipe' },
      { value: 'fa-lightbulb', label: 'üí° Cr√©ativit√©' },
      { value: 'fa-comments', label: 'üí¨ Communication' },
      { value: 'fa-heart', label: '‚ù§Ô∏è Empathie' },
      { value: 'fa-scale-balanced', label: '‚öñÔ∏è Rigueur' }
    ];
    
    // === VARIABLES GLOBALES ===
    let currentEditSlug = null;
    let statsCount = 0;
    let skillsCount = 0;
    
    // === FONCTIONS ADMIN ===
    function chargerListeSecteurs() {
      const secteurs = window.SecteursAPI.getAllSecteurs();
      const container = document.getElementById('liste-secteurs');
      
      if (!container) return;
      
      if (Object.keys(secteurs).length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #64748b;">
            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Aucun secteur publi√©</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = Object.entries(secteurs)
        .map(([slug, secteur]) => `
          <div class="secteur-item">
            <div>
              <h4 style="margin: 0 0 5px 0; color: #1e293b;">${secteur.titre}</h4>
              <small style="color: #64748b;">Slug: ${slug}</small>
              <div style="display: flex; gap: 10px; margin-top: 5px;">
                <span style="font-size: 0.8em; background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 10px;">
                  <i class="fas fa-graduation-cap"></i> ${secteur.filieresCount || '0'} fili√®res
                </span>
                <span style="font-size: 0.8em; background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 10px;">
                  <i class="fas fa-school"></i> ${secteur.etabsCount || '0'} √©tablissements
                </span>
              </div>
            </div>
            <div class="secteur-actions">
              <a href="secteur.html?slug=${slug}" target="_blank" class="btn-icon view" title="Voir">
                <i class="fas fa-eye"></i>
              </a>
              <button class="btn-icon edit" onclick="editerSecteur('${slug}')" title="Modifier">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-icon delete" onclick="supprimerSecteur('${slug}')" title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `)
        .join('');
    }
    
    function mettreAJourApercu() {
      const titre = document.getElementById('ext_titre').value;
      const image = document.getElementById('ext_image').value;
      const resume = document.getElementById('ext_resume').value;
      
      // Aper√ßu carte
      const previewHero = document.getElementById('preview-hero');
      const previewImg = document.getElementById('preview-img');
      
      if (image) {
        previewImg.src = image;
        previewImg.style.display = 'block';
        previewHero.style.backgroundImage = `url('${image}')`;
      } else {
        previewImg.style.display = 'none';
        previewHero.style.backgroundImage = 'none';
        previewHero.style.backgroundColor = '#e5e7eb';
      }
      
      document.getElementById('preview-titre').textContent = titre || "Titre du secteur";
      document.getElementById('preview-resume').textContent = resume || "Description...";
      
      // Aper√ßu des stats
      const statsContainer = document.getElementById('preview-stats');
      const statFields = document.querySelectorAll('.stat-field');
      
      if (statFields.length === 0) {
        statsContainer.innerHTML = "Aucun chiffre cl√© ajout√©";
      } else {
        statsContainer.innerHTML = statFields.map(field => {
          const iconInput = field.querySelector('input[name="stat_icon"]');
          const icon = iconInput ? iconInput.value : 'fa-chart-bar';
          const value = field.querySelector('input[name="stat_value"]')?.value || '';
          const label = field.querySelector('input[name="stat_label"]')?.value || '';
          
          if (!value && !label) return '';
          
          return `
            <div style="margin-bottom: 10px; padding: 12px; background: #f0f9ff; border-radius: 8px; display: flex; align-items: center; gap: 12px;">
              <i class="fas ${icon}" style="color: #0b4da2; font-size: 1.3em; min-width: 30px;"></i>
              <div style="flex: 1;">
                <strong style="display: block; font-size: 1.1em; color: #1e293b;">${value}</strong>
                <span style="color: #4b5563; font-size: 0.9em;">${label}</span>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // Aper√ßu des comp√©tences
      const skillsContainer = document.getElementById('preview-skills');
      const skillFields = document.querySelectorAll('.skill-field');
      
      if (skillFields.length === 0) {
        skillsContainer.innerHTML = "Aucune comp√©tence ajout√©e";
      } else {
        skillsContainer.innerHTML = skillFields.map(field => {
          const iconInput = field.querySelector('input[name="skill_icon"]');
          const icon = iconInput ? iconInput.value : 'fa-star';
          const label = field.querySelector('input[name="skill_label"]')?.value || '';
          
          if (!label) return '';
          
          return `
            <div style="display: inline-flex; align-items: center; margin: 5px; padding: 10px 16px; 
                        background: #e0f2fe; border-radius: 20px; font-size: 0.9em; gap: 10px;">
              <i class="fas ${icon}" style="color: #0b4da2; font-size: 1.1em;"></i>
              <span style="font-weight: 500;">${label}</span>
            </div>
          `;
        }).join('');
      }
    }
    
    function afficherMessage(message, type = 'info') {
      const container = document.getElementById('message-container');
      const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6'
      };
      
      const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
      
      const html = `
        <div class="message" style="background: ${colors[type] + '20'}; border: 1px solid ${colors[type]}; color: ${colors[type]}; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-${icon}" style="font-size: 1.2em;"></i>
          <span>${message}</span>
        </div>
      `;
      
      container.innerHTML = html;
      
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
    
    function creerSelecteurIcones(iconsArray, name, selectedIcon = '') {
      const selected = selectedIcon || iconsArray[0].value;
      
      return `
        <div class="icon-selector">
          <label style="font-size: 0.85em; display: block; margin-bottom: 8px;">Ic√¥ne</label>
          <div class="icon-options">
            ${iconsArray.map(icon => `
              <button type="button" class="icon-option ${selected === icon.value ? 'selected' : ''}" 
                      data-icon="${icon.value}"
                      style="padding: 8px 12px; border: 2px solid ${selected === icon.value ? '#0b4da2' : '#e2e8f0'}; 
                             background: ${selected === icon.value ? '#e0f2fe' : 'white'}; 
                             border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                <i class="fas ${icon.value}" style="color: #0b4da2;"></i>
                <span style="font-size: 0.85em;">${icon.label}</span>
              </button>
            `).join('')}
          </div>
          <input type="hidden" name="${name}" value="${selected}">
        </div>
      `;
    }
    
    function ajouterChampStat(statData = {}) {
      statsCount++;
      const id = `stat-${statsCount}`;
      const selectedIcon = statData.icon || statIcons[0].value;
      
      const html = `
        <div class="stat-field" id="${id}">
          <div class="field-header">
            <h4>Chiffre cl√© #${statsCount}</h4>
            <button type="button" class="btn-delete" onclick="supprimerChamp('${id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div style="margin-bottom: 15px;">
            ${creerSelecteurIcones(statIcons, 'stat_icon', selectedIcon)}
          </div>
          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 0.85em;">Valeur</label>
              <input type="text" name="stat_value" placeholder="+ 5000" value="${statData.value || ''}" 
                     class="stat-input" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>
            <div>
              <label style="font-size: 0.85em;">Description</label>
              <input type="text" name="stat_label" placeholder="entreprises sp√©cialis√©es" value="${statData.label || ''}" 
                     class="stat-input" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('stats-container').insertAdjacentHTML('beforeend', html);
      
      // Ajouter les √©couteurs d'√©v√©nements pour les boutons d'ic√¥nes
      const iconOptions = document.querySelectorAll(`#${id} .icon-option`);
      iconOptions.forEach(option => {
        option.addEventListener('click', function() {
          const icon = this.getAttribute('data-icon');
          const field = this.closest('.stat-field');
          const input = field.querySelector('input[name="stat_icon"]');
          input.value = icon;
          
          // Mettre √† jour l'apparence
          field.querySelectorAll('.icon-option').forEach(opt => {
            opt.classList.remove('selected');
            opt.style.borderColor = '#e2e8f0';
            opt.style.background = 'white';
          });
          this.classList.add('selected');
          this.style.borderColor = '#0b4da2';
          this.style.background = '#e0f2fe';
          
          mettreAJourApercu();
        });
      });
      
      mettreAJourApercu();
    }
    
    function ajouterChampCompetence(skillData = {}) {
      skillsCount++;
      const id = `skill-${skillsCount}`;
      const selectedIcon = skillData.icon || skillIcons[0].value;
      
      const html = `
        <div class="skill-field" id="${id}">
          <div class="field-header">
            <h4>Comp√©tence #${skillsCount}</h4>
            <button type="button" class="btn-delete" onclick="supprimerChamp('${id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div style="margin-bottom: 15px;">
            ${creerSelecteurIcones(skillIcons, 'skill_icon', selectedIcon)}
          </div>
          <div>
            <label style="font-size: 0.85em;">Nom de la comp√©tence</label>
            <input type="text" name="skill_label" placeholder="Esprit d'√©quipe" value="${skillData.label || ''}" 
                   class="skill-input" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 4px;">
          </div>
        </div>
      `;
      
      document.getElementById('skills-container').insertAdjacentHTML('beforeend', html);
      
      // Ajouter les √©couteurs d'√©v√©nements pour les boutons d'ic√¥nes
      const iconOptions = document.querySelectorAll(`#${id} .icon-option`);
      iconOptions.forEach(option => {
        option.addEventListener('click', function() {
          const icon = this.getAttribute('data-icon');
          const field = this.closest('.skill-field');
          const input = field.querySelector('input[name="skill_icon"]');
          input.value = icon;
          
          // Mettre √† jour l'apparence
          field.querySelectorAll('.icon-option').forEach(opt => {
            opt.classList.remove('selected');
            opt.style.borderColor = '#e2e8f0';
            opt.style.background = 'white';
          });
          this.classList.add('selected');
          this.style.borderColor = '#0b4da2';
          this.style.background = '#e0f2fe';
          
          mettreAJourApercu();
        });
      });
      
      mettreAJourApercu();
    }
    
    window.supprimerChamp = function(id) {
      const element = document.getElementById(id);
      if (element) {
        element.remove();
        mettreAJourApercu();
      }
    };
    
    window.editerSecteur = function(slug) {
      const secteur = window.SecteursAPI.getSecteurBySlug(slug);
      
      if (!secteur) return;
      
      currentEditSlug = slug;
      
      // Vider les conteneurs de stats et skills
      document.getElementById('stats-container').innerHTML = '';
      document.getElementById('skills-container').innerHTML = '';
      
      // R√©initialiser les compteurs
      statsCount = 0;
      skillsCount = 0;
      
      // Remplir les champs de base
      document.getElementById('ext_titre').value = secteur.titre || '';
      document.getElementById('ext_image').value = secteur.image || '';
      document.getElementById('ext_resume').value = secteur.resume || '';
      document.getElementById('int_hero').value = secteur.heroImage || '';
      document.getElementById('int_presentation').value = Array.isArray(secteur.presentation) 
        ? secteur.presentation.join('\n\n') 
        : secteur.presentation || '';
      document.getElementById('int_video').value = secteur.video || '';
      document.getElementById('filieres_count').value = secteur.filieresCount || '1';
      document.getElementById('etabs_count').value = secteur.etabsCount || '1';
      document.getElementById('filieres_intro').value = secteur.filieresIntro || '';
      
      // Remplir les stats
      if (secteur.stats && Array.isArray(secteur.stats)) {
        secteur.stats.forEach(stat => {
          ajouterChampStat(stat);
        });
      }
      
      // Remplir les comp√©tences
      if (secteur.skills && Array.isArray(secteur.skills)) {
        secteur.skills.forEach(skill => {
          ajouterChampCompetence(skill);
        });
      }
      
      // Mettre √† jour l'aper√ßu
      mettreAJourApercu();
      
      // Changer le bouton
      document.getElementById('btn-publier').innerHTML = '<i class="fas fa-save"></i> Mettre √† jour';
      document.getElementById('btn-publier').onclick = sauvegarderSecteur;
      
      afficherMessage(`√âdition du secteur: ${secteur.titre}`, 'info');
    };
    
    function sauvegarderSecteur() {
      // Collecter les donn√©es
      const secteur = collecterDonneesSecteur();
      
      if (!secteur) return;
      
      // Sauvegarder
      const success = window.SecteursAPI.saveSecteur(secteur);
      
      if (success) {
        afficherMessage(
          currentEditSlug ? 'Secteur mis √† jour avec succ√®s!' : 'Secteur publi√© avec succ√®s!',
          'success'
        );
        
        // R√©initialiser le formulaire
        reinitialiserFormulaire();
        
        // Recharger la liste
        chargerListeSecteurs();
      } else {
        afficherMessage('Erreur lors de la sauvegarde', 'error');
      }
    }
    
    function collecterDonneesSecteur() {
      const titre = document.getElementById('ext_titre').value.trim();
      
      if (!titre) {
        afficherMessage('Le titre est obligatoire', 'error');
        return null;
      }
      
      // Utiliser le slug existant en √©dition, ou g√©n√©rer un nouveau
      const slug = currentEditSlug || window.SecteursAPI.generateSlug(titre);
      
      // Pr√©parer les tableaux pour pr√©sentation
      const presentationText = document.getElementById('int_presentation').value.trim();
      const presentation = presentationText ? presentationText.split('\n\n').filter(p => p.trim()) : [];
      
      // Collecter les stats
      const stats = [];
      const statFields = document.querySelectorAll('.stat-field');
      statFields.forEach(field => {
        const iconInput = field.querySelector('input[name="stat_icon"]');
        const icon = iconInput ? iconInput.value : statIcons[0].value;
        const value = field.querySelector('input[name="stat_value"]')?.value.trim();
        const label = field.querySelector('input[name="stat_label"]')?.value.trim();
        
        if (value && label) {
          stats.push({
            icon: icon,
            value: value,
            label: label
          });
        }
      });
      
      // Collecter les comp√©tences
      const skills = [];
      const skillFields = document.querySelectorAll('.skill-field');
      skillFields.forEach(field => {
        const iconInput = field.querySelector('input[name="skill_icon"]');
        const icon = iconInput ? iconInput.value : skillIcons[0].value;
        const label = field.querySelector('input[name="skill_label"]')?.value.trim();
        
        if (label) {
          skills.push({
            icon: icon,
            label: label
          });
        }
      });
      
      return {
        titre: titre,
        slug: slug,
        image: document.getElementById('ext_image').value.trim(),
        resume: document.getElementById('ext_resume').value.trim(),
        heroImage: document.getElementById('int_hero').value.trim(),
        presentation: presentation,
        video: document.getElementById('int_video').value.trim(),
        filieresCount: document.getElementById('filieres_count').value || '1',
        etabsCount: document.getElementById('etabs_count').value || '1',
        filieresIntro: document.getElementById('filieres_intro').value.trim(),
        stats: stats,
        skills: skills,
        brochureUrl: "#"
      };
    }
    
    function reinitialiserFormulaire() {
      document.getElementById('ext_titre').value = '';
      document.getElementById('ext_image').value = '';
      document.getElementById('ext_resume').value = '';
      document.getElementById('int_hero').value = '';
      document.getElementById('int_presentation').value = '';
      document.getElementById('int_video').value = '';
      document.getElementById('filieres_count').value = '1';
      document.getElementById('etabs_count').value = '1';
      document.getElementById('filieres_intro').value = '';
      
      // Vider les stats et skills
      document.getElementById('stats-container').innerHTML = '';
      document.getElementById('skills-container').innerHTML = '';
      
      // R√©initialiser les compteurs
      statsCount = 0;
      skillsCount = 0;
      
      currentEditSlug = null;
      
      // Restaurer le bouton original
      document.getElementById('btn-publier').innerHTML = '<i class="fas fa-paper-plane"></i> Publier le secteur';
      document.getElementById('btn-publier').onclick = sauvegarderSecteur;
      
      // Ajouter un champ vide par d√©faut
      ajouterChampStat();
      ajouterChampCompetence();
      
      mettreAJourApercu();
    }
    
    window.supprimerSecteur = function(slug) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce secteur ?')) return;
      
      const success = window.SecteursAPI.deleteSecteur(slug);
      
      if (success) {
        afficherMessage('Secteur supprim√© avec succ√®s', 'success');
        chargerListeSecteurs();
        
        // Si on √©tait en train d'√©diter ce secteur, r√©initialiser le formulaire
        if (currentEditSlug === slug) {
          reinitialiserFormulaire();
        }
      } else {
        afficherMessage('Erreur lors de la suppression', 'error');
      }
    };
    
    // === INITIALISATION ===
    document.addEventListener('DOMContentLoaded', function() {
      // V√©rifier si on est authentifi√© avant d'afficher l'interface admin
      if (isAuthenticated()) {
        console.log('Auth r√©ussie, initialisation interface admin');
        
        // Afficher le contenu admin
        document.getElementById('admin-content').style.display = 'block';
        
        // V√©rifier que l'API est charg√©e
        if (!window.SecteursAPI) {
          console.error("API des secteurs non charg√©e");
          return;
        }
        
        // Initialiser les √©v√©nements
        document.getElementById('btn-publier').addEventListener('click', sauvegarderSecteur);
        document.getElementById('btn-annuler').addEventListener('click', reinitialiserFormulaire);
        document.getElementById('add-stat').addEventListener('click', () => ajouterChampStat());
        document.getElementById('add-skill').addEventListener('click', () => ajouterChampCompetence());
        
        // √âcouter les changements pour l'aper√ßu
        ['ext_titre', 'ext_image', 'ext_resume'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('input', mettreAJourApercu);
          }
        });
        
        // √âcouter les changements dans les champs de stats et skills
        document.addEventListener('input', function(e) {
          if (e.target.classList.contains('stat-input') || e.target.classList.contains('skill-input')) {
            mettreAJourApercu();
          }
        });
        
        // Charger initialement
        chargerListeSecteurs();
        mettreAJourApercu();
        
        // Ajouter un premier champ de stat et comp√©tence par d√©faut
        ajouterChampStat();
        ajouterChampCompetence();
      } else {
        console.log('Non authentifi√©, login screen affich√©');
        // Le login screen est d√©j√† affich√© par la fonction protectPage()
      }
    });
  </script>
</body>
</html>